<!DOCTYPE html>
<meta charset="UTF-8">
<html>
    
    <title id="NavBar"> 
        My Profile
    </title>
    
    <head>
        <link rel="stylesheet" type="text/css" href="css/profile.css">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Roboto+Condensed:300'>
        <script type="text/javascript" src="js/jquery-2.1.1.js"></script>
        <script src="js/parse.min.js"></script>
        <script src="js/validator.js"></script>
        <script src="cordova.js"></script>
        
    </head>

    <body>
        <div id="navbarLog"></div>
        <br>
        <div class="containter">
            <div class="text-center" id="content" style="text-align:center;">
                <div class="navtab1">
                    <div class="user-image">
                    <img id="gImageID" src=""  width="100" height="100" class="img-circle">
                    </div>
                    <div class="user-heading" id="fullname">
                        <h3 id="topFullname"></h3>
                        <span id="topLoc" class="help-block"></span>
                    </div>
                    <ul id="tabs" class="nav navtab1 nav-tabs" data-tabs="tabs">
                        <li class="active">
                            <a data-toggle="tab" href="#information">
                                <span class="fa fa-user"></span>
                            </a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#events">
                                <span class="fa fa-calendar"></span>
                            </a>
                        </li>
                        <li>
                            <a data-toggle="tab" href="#edit">
                                <span class="fa fa-pencil"></span>
                            </a>
                        </li>
                        <!-- <li>
                            <a data-toggle="tab" href="#settings">
                                <span class="fa fa-cog"></span>
                            </a>
                        </li >-->
                    </ul>
                </div>
            </div>
            <div class="info">
                <div id="my-tab-content" class="tab-content">
                    <div class="tab-pane active" id="information">
                        <form id="displayInfo" action="javascript:retrieveInfo()">
                            <h1>General Info</h1>
                            <div class="container-fluid">
                                <div id="gInfoID" class="row col-lg-8">
                                    <div class="col-xs-4 leftblock">Name:</div>
                                    <div class="col-xs-8 col-centered" id="gFnameID"></div>
                                    <div class="col-xs-4 leftblock">Location:</div>
                                    <div class="col-xs-8 col-centered" id="gLocID"></div>
                                    <div class="col-xs-4 leftblock">School:</div>
                                    <div class="col-xs-8 col-centered" id="gSchoolID"></div>
                                    <div class="col-xs-4 leftblock">Grade:</div>
                                    <div class="col-xs-8 col-centered" id="gGradeID"></div>
                                </div>
                            </div>  
                        </form>
                    </div>
                    <div class="tab-pane center" id="events">
                        <h1>Your Events</h1>
                        <!-- <p class="center">To be update</p> -->
                        <div class="container-fluid">
                            <div id="gInfoID" class="row col-lg-8">
                                <div class="center" id="eNameID"></div>
                            </div>
                        </div>  
                    </div>
                    <div class="tab-pane" id="edit">
                        <h1>Edit Profile</h1>

                        <div class="container">
                          <div class="text-center">
                            <hr>
                              <div class="row">
                                <!-- left column -->
                                <div class="col-md-3" >
                                    <div class="text-center">
                                        <img id="imgID" width="100" height="100" class="avatar img-circle">
                                        <h6>Upload a different photo...</h6>
                                        <button id="photoBtn">Upload a photo</button>
                                    </div>
                                </div>
                                
                                <!-- edit form column -->
                                <div class="col-md-9 personal-info">
                                    <div id="alert" hidden="true" class="alert alert-info alert-dismissable alert-success">
                                        <a class="panel-close close" data-dismiss="alert">Ã—</a> 
                                        <i class="fa fa-coffee"> Hi!</i>
                                    </div>
                                    <h3>Personal info</h3>
                                  
                                    <form class="form-horizontal" id="updateInfo" data-toggle="validator">
                                        <div class="form-group">
                                            <label class="col-lg-3 control-label">First name: </label>
                                            <div class="col-lg-8">
                                                <textarea rows="1" class="form-control" type="text" id="fnameID"></textarea>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">Last name:</label>
                                          <div class="col-lg-8">
                                            <textarea rows="1" class="form-control" type="text" id="lnameID" placeholder="Doe" ></textarea>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">School:</label>
                                          <div class="col-lg-8">
                                            <textarea rows="1" class="form-control" type="text" id="schoolID" placeholder="CSULB"></textarea>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">Grade:</label>
                                          <div class="col-lg-8">
                                            <textarea rows="1" class="form-control" type="text" id="gradeID" placeholder="sophomore/junior/senior/etc."></textarea>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">Email:</label>
                                          <div class="col-lg-8">
                                            <textarea rows="1" class="form-control" type="text" id="emailID" placeholder="yourEmail@Thirst.org"></textarea>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">Location:</label>
                                          <div class="col-lg-8">
                                            <textarea rows="1" class="form-control" type="text" id="locationID" placeholder="Location"></textarea>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">Password *:</label>
                                          <div class="col-md-8">
                                            <input class="form-control " required id="pwID" type="password" placeholder="password"></input>
                                            <div class="help-block has-errors"></div>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-lg-3 control-label">Confirm password *:</label>
                                          <div class="col-md-8">
                                            <input class="form-control " required id="cpwID" type="password" placeholder="confirm password"></input>
                                            <div class="help-block has-errors"></div>
                                          </div>
                                        </div>
                                        <div class="form-group">
                                          <label class="col-md-3 control-label"></label>
                                          <div class="col-md-8">
                                            <input type="button" class="btn btn-primary" value="Submit" onclick="update()">
                                            <span></span>
                                            <input type="reset" class="btn btn-default" value="Cancel">
                                          </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                          </div>
                        </div> <!-- end edit profile portion -->
                    </div>
                    <!-- <div class="tab-pane center" id="settings">
                        <h1>Settings</h1>
                        <input type="checkbox" name="option" value="notif"> Notification(on/off)
                    </div> -->
                </div>
            </div>
        </div>

        <script type="text/javascript">
            Parse.initialize("YgscJuPF5n0Tab0kShVye4KdCKQZx8E3yzdC8804", "o5kLLsJQTT4Xc5yR4FlQHngF31txDtfXDnTREq1C");

            //loadImage();

            $(function(){
                    $("#navbarLog").load("navbarLog.html");   
                    $("#socialBtns").load("socialBtns.html");
                });

            $(document).ready(function(){
                
                    $("#upload").click(function(){
                        $("#imageID").click();
                        
                    });

                    retrieveUserInfo();
                    loadImage();
                    retrieveEvent();
            })

            function update(){
                updateProf();
                updateImage();
            }
            
            function updateProf(){
                var User = Parse.Object.extend("User");
                var currentUser = Parse.User.current();
                var query= new Parse.Query(User);
                var currentUserID = currentUser.id;

                query.get(currentUserID, {

                    success: function(update){
                        var email = document.getElementById("emailID").value;
                        var fname = document.getElementById("fnameID").value;
                        var lname = document.getElementById("lnameID").value;
                        var school= document.getElementById("schoolID").value;
                        var grade = document.getElementById("gradeID").value;
                        var location = document.getElementById("locationID").value;
                        var pw = document.getElementById("pwID").value;
                        var cpw = document.getElementById("cpwID").value;

                        var text;

                        if((pw == cpw) & (pw != null) & (cpw != null) & (pw.length > 0) & (cpw > 0))
                        {    
                            var choice = confirm("You sure still want to update your information? :)");

                            if(choice == true)
                            {
                                update.set("email", email);
                                update.set("fname", fname);                       
                                update.set("lname", lname);                      
                                update.set("school", school);                        
                                update.set("password", pw);                        
                                update.set("grade", grade);                        
                                update.set("location", location);
                                update.save().then(function(){

                                    alert("Profile updated!");
                                    retrieveUserInfo();
                                    loadImage();
                                });
                                
                            }
                            else
                            {
                                alert("You did not change your info");
                            }
                            

                        }
                        else
                        {
                            alert("You either did not enter your password or you password does not match, please try again!");
                        }

                    },
                    error: function(user, error){
                        alert("failed");
                        console.log(error.message);
                    }
                });
                
            }

            function retrieveUserInfo(){

                var User = Parse.Object.extend("User");
                var currentUser = Parse.User.current();
                var query= new Parse.Query(User);
                var currentUserID = currentUser.id;

                query.get(currentUserID, {

                    success: function(retrieve){
                        var rFname = retrieve.get("fname");
                        var rLname = retrieve.get("lname");
                        var rSchool = retrieve.get("school");
                        var rGrade = retrieve.get("grade");
                        var rLocation = retrieve.get("location");
                        var rPassword = retrieve.get("password");
                        var rEmail = retrieve.get("email");

                        // get and set edit info fields
                        var fnameField = document.getElementById("fnameID");
                        var lnameField = document.getElementById("lnameID");
                        var schoolField = document.getElementById("schoolID");
                        var gradeField = document.getElementById("gradeID");
                        var locationField = document.getElementById("locationID");
                        var pwField = document.getElementById("pwID");
                        var cpwField = document.getElementById("cpwID");
                        var email = document.getElementById("emailID");

                        fnameField.innerHTML = rFname;
                        lnameField.innerHTML = rLname;
                        schoolField.innerHTML = rSchool;
                        gradeField.innerHTML = rGrade;
                        locationField.innerHTML = rLocation;
                        pwField.innerHTML = rPassword;
                        cpwField.innerHTML = rPassword;    
                        email.innerHTML =  rEmail; 

                        var fullName = rFname + " " + rLname;

                        //set general info field
                        document.getElementById("gFnameID").innerHTML = fullName;
                        document.getElementById("gLocID").innerHTML = rLocation;
                        document.getElementById("gSchoolID").innerHTML = rSchool;
                        document.getElementById("gGradeID").innerHTML = rGrade;

                        // set top info field
                        document.getElementById("topFullname").innerHTML = fullName;
                        document.getElementById("topLoc").innerHTML = rLocation;

                    },
                    error: function(query, error){
                        alert("Could not retrieve your information! :(");
                   
                        }
                });
            }

            function loadImage(){

                var photoURL = "";
                var User = Parse.Object.extend("User");
                var currentUser = Parse.User.current();
                var query= new Parse.Query(User);
                var currentUserID = currentUser.id;

                query.get(currentUserID, {
                    success: function(profile){
                        var photo = profile.get("img"); 
                        photoURL = photo.url();
                        
                        $('#gImageID')[0].src = photoURL;
                        $('#imgID')[0].src = photoURL;
                    }, 
                    error: function(object, error){
                        alert("Could not retrieve your iamge! :(");
                    }
                });        
            }

            function retrieveEvent(){
                var User = Parse.Object.extend("User");
                var currentUser = Parse.User.current();
                var query= new Parse.Query(User);
                var currentUserID = currentUser.id;
                
                query.get(currentUserID,{
                    success: function(theEvent){
                        // get rsvp from user
                        var eRSVP = theEvent.get("rsvp");
                        eRSVP = eRSVP.split(",");
                        
                        document.getElementById("eNameID").innerHTML = "";
                        for(var i=0; i<eRSVP.length;i++){

                            var Event = Parse.Object.extend("Event");
                            var queryEvent= new Parse.Query(Event);
                            queryEvent.get(eRSVP[i], {
                                success: function(event){
                                    var temp = document.getElementById("eNameID").innerHTML;
                                    document.getElementById("eNameID").innerHTML = temp +event.get("title") + "<br/>" ;
                                },
                                error: function(query, error){
                                   
                                }
                            });
                        }//end for

                    },
                    error: function(query, error){
                        alert("Could not retrieve your information! :(");
                   
                        }
                    });
            }
            
            function updateImage(){

                //query to parse for the each user's objectID
                var User = Parse.Object.extend("User");
                var query = new Parse.Query(User);
                var currentUser = Parse.User.current();
                var currentUserID = currentUser.id;

                //grab the image in a variable
                var upImage = $("#imageID")[0];
                if (upImage.files.length > 0 ){

                    var file = upImage.files[0];
                    var name = "profilePhoto.png";

                    var parseFile = new Parse.File(name, file);

                    parseFile.save().then(function(){
                            
                            query.get(currentUserID, {
                                    success: function(sendimage){    
                                        //save the image
                                        sendimage.set("img", parseFile);
                                        sendimage.save();
                                    }, 
                                    error: function(object, error){
                                }
                            });
                        }, 
                        function(error) {
                          alert("Could not update image :(");
                        })
                }
            }

            $("#photoBtn").on("click", function(e) {
                e.preventDefault();
                navigator.camera.getPicture(gotPic, failHandler, 
                    {quality:50, destinationType:navigator.camera.DestinationType.DATA_URL,
                     sourceType:navigator.camera.PictureSourceType.PHOTOLIBRARY});
            });


        </script>

        <script type="text/javascript" src='js/bootstrap.js'></script>

    </body>
</html>